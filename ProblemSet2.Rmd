---
title: "ProblemSet2"
output: html_document
---

```{r, warning=FALSE, message=FALSE}
# Carga de librerias
# --- Paquetes ---
library(haven)      # leer .dta
library(ggplot2)    # gráficos
library(rddensity)  # test de manipulación
library(fixest)     # regresiones con FE
library(rdrobust)   # rdplot
library(dplyr)
library(ggpubr)     # Combinar gráficos
```

```{r}
bbdd = read_dta("./data/casestudy_dropout.dta")
bbdd
```

### Pregunta 1

```{r}
ggplot(bbdd, aes(x = SchoolDaysFromMay302022)) +
  geom_histogram(binwidth = 1, fill = "lightblue", color = "black") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  labs(title = "Distribución de la running variable",
       x = "Días escolares desde 30 de mayo 2022",
       y = "Frecuencia")

# 1. Construir tabla de frecuencias
freq_df <- bbdd %>%
  count(SchoolDaysFromMay302022)

# 2. Ajustar regresiones lineales a cada lado del cutoff
lm_left  <- lm(n ~ SchoolDaysFromMay302022, data = subset(freq_df, SchoolDaysFromMay302022 < 0))
lm_right <- lm(n ~ SchoolDaysFromMay302022, data = subset(freq_df, SchoolDaysFromMay302022 >= 0))

# 3. Graficar histograma + líneas ajustadas
ggplot(freq_df, aes(x = SchoolDaysFromMay302022, y = n)) +
  geom_col(fill = "lightblue", color = "black") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  geom_smooth(data = subset(freq_df, SchoolDaysFromMay302022 < 0),
              method = "lm", se = FALSE, color = "blue") +
  geom_smooth(data = subset(freq_df, SchoolDaysFromMay302022 >= 0),
              method = "lm", se = FALSE, color = "green") +
  labs(title = "Distribución de la running variable con ajuste lineal",
       x = "Días escolares desde 30 de mayo 2022",
       y = "Frecuencia")

# Test de densidad en el cutoff
dens_test <- rddensity(X = bbdd$SchoolDaysFromMay302022, c = 0)
summary(dens_test)

# Gráfico de la densidad estimada
rdplotdensity(dens_test, bbdd$SchoolDaysFromMay302022)






```

### Pregunta 2

```{r}
# ============================================================
# 2. First stage graph
# ============================================================

# (a) Gráfico
# (a) Gráfico con bbdd
ggplot(bbdd, aes(x = SchoolDaysFromMay302022, y = ListedInDropoutReport)) +
  geom_point(alpha = 0.3) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
  geom_smooth(data = subset(bbdd, SchoolDaysFromMay302022 < 0),
              method = "lm", se = FALSE, color = "blue") +
  geom_smooth(data = subset(bbdd, SchoolDaysFromMay302022 >= 0),
              method = "lm", se = FALSE, color = "green") +
  labs(title = "First stage graph",
       x = "Running variable (days from May 30)",
       y = "Prob. de estar listado en el reporte")


# (b) Regresión con FE por escuela
fs_model <- feols(ListedInDropoutReport ~ DroppedOutMay30Before *
                    SchoolDaysFromMay302022 | IDschool, data = bbdd)
summary(fs_model)

# (c) Incluir FE por día de la semana
fs_model_dow <- feols(ListedInDropoutReport ~ DroppedOutMay30Before *
                        SchoolDaysFromMay302022 | IDschool + DayOfWeekDroppedOut,
                      data = bbdd)
summary(fs_model_dow)

```

### Pregunta 3

```{r}

#RD lineal EnrolledByAug312022

rd_enrolled <- feols(
  EnrolledByAug312022 ~ DroppedOutMay30Before + SchoolDaysFromMay302022 + DroppedOutMay30Before:SchoolDaysFromMay302022 | 
  IDschool + DayOfWeekDroppedOut,
  data = bbdd, cluster = "IDschool" #esto hace que los errores estándar se ajusten por correlación dentro de cada escuela
)
summary(rd_enrolled)

#RD lineal GraduatedIn2022
rd_graduated <- feols(
  GraduatedIn2022 ~ DroppedOutMay30Before + SchoolDaysFromMay302022 + DroppedOutMay30Before:SchoolDaysFromMay302022 | 
  IDschool + DayOfWeekDroppedOut,
  data = bbdd, cluster = "IDschool"
)
summary(rd_graduated)


```

### Pregunta 4

```{r}
#EnrolledByAug312022
plot_enrolled <- rdplot(y = bbdd$EnrolledByAug312022, x = bbdd$SchoolDaysFromMay302022, c = 0,
                        title = "Revinculación al 31 de agosto")

#GraduatedIn2022
plot_graduated <- rdplot(y = bbdd$GraduatedIn2022, x = bbdd$SchoolDaysFromMay302022, c = 0,
                         title = "Graduación en 2022")

#Gráficos
g1 <- plot_enrolled$rdplot
g2 <- plot_graduated$rdplot

#Combinar gráficos 
ggarrange(g1, g2, ncol = 2, nrow = 1)

```

### Pregunta 5

```{r}
#EnrolledByAug312022 con términos cuadráticos
rd_quad_enrolled <- feols(
  EnrolledByAug312022 ~ DroppedOutMay30Before +
    SchoolDaysFromMay302022 + I(SchoolDaysFromMay302022^2) +
    DroppedOutMay30Before:SchoolDaysFromMay302022 + DroppedOutMay30Before:I(SchoolDaysFromMay302022^2) |
    IDschool + DayOfWeekDroppedOut,
  data = bbdd, cluster = "IDschool"
)
summary(rd_quad_enrolled)

#GraduatedIn2022 con términos cuadráticos
rd_quad_graduated <- feols(
  GraduatedIn2022 ~ DroppedOutMay30Before +
    SchoolDaysFromMay302022 + I(SchoolDaysFromMay302022^2) +
    DroppedOutMay30Before:SchoolDaysFromMay302022 + DroppedOutMay30Before:I(SchoolDaysFromMay302022^2) |
    IDschool + DayOfWeekDroppedOut,
  data = bbdd, cluster = "IDschool"
)
summary(rd_quad_graduated)

```

### Pregunta 6

```{r}
#Proyección cuadrática
plot_quad <- rdplot(y = bbdd$EnrolledByAug312022, x = bbdd$SchoolDaysFromMay302022, c = 0, p = 2,
                    title = "Revinculación - Proyección cuadrática")

#Proyección cúbica
plot_cubic <- rdplot(y = bbdd$EnrolledByAug312022, x = bbdd$SchoolDaysFromMay302022, c = 0, p = 3,
                     title = "Revinculación - Proyección cúbica")

#Combinar ambos gráficos
ggarrange(plot_quad$rdplot, plot_cubic$rdplot, ncol = 2, nrow = 1)

```

### WAR
