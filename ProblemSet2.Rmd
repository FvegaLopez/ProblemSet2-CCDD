---
title: "ProblemSet2"
output: html_document
---

```{r, warning=FALSE, message=FALSE}
# Carga de librerias
# --- Paquetes ---
library(haven)      # leer .dta
library(ggplot2)    # gráficos
library(rddensity)  # test de manipulación
library(fixest)     # regresiones con FE
library(rdrobust)   # rdplot
library(dplyr)
library(ggpubr)     # Combinar gráficos
library(modelsummary)
library(knitr)
library(kableExtra)
```

```{r}
bbdd = read_dta("./data/casestudy_dropout.dta")
bbdd
```

### Pregunta 1

```{r}
# --- Gráfico 1: histograma simple ---
p1 <- ggplot(bbdd, aes(x = SchoolDaysFromMay302022)) +
  geom_histogram(binwidth = 1, fill = "lightblue", color = "black") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  labs(title = "Distribución de la running variable",
       x = "Días escolares desde 30 de mayo 2022",
       y = "Frecuencia")

p1

ggsave(filename ="./outputs/grafico1_histograma.png", plot = p1, width = 7, height = 5)

# 1. Construir tabla de frecuencias
freq_df <- bbdd %>%
  count(SchoolDaysFromMay302022)

# 2. Ajustar regresiones lineales a cada lado del cutoff
lm_left  <- lm(n ~ SchoolDaysFromMay302022, data = subset(freq_df, SchoolDaysFromMay302022 < 0))
lm_right <- lm(n ~ SchoolDaysFromMay302022, data = subset(freq_df, SchoolDaysFromMay302022 >= 0))

# 3. Graficar histograma + líneas ajustadas
p2 <- ggplot(freq_df, aes(x = SchoolDaysFromMay302022, y = n)) +
  geom_col(fill = "lightblue", color = "black") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  geom_smooth(data = subset(freq_df, SchoolDaysFromMay302022 < 0),
              method = "lm", se = FALSE, color = "blue") +
  geom_smooth(data = subset(freq_df, SchoolDaysFromMay302022 >= 0),
              method = "lm", se = FALSE, color = "green") +
  labs(title = "Distribución de la running variable con ajuste lineal",
       x = "Días escolares desde 30 de mayo 2022",
       y = "Frecuencia")

p2

ggsave(filename = "./outputs/grafico2_histograma_lineal.png", plot = p2, width = 7, height = 5)


library(xtable)

# Test de densidad
dens_test <- rddensity(X = bbdd$SchoolDaysFromMay302022, c = 0)
dens_test
res <- summary(dens_test)


# Guardar gráfico de densidad
png(filename = "./outputs/grafico3_rddensity.png", width = 800, height = 600)
rdplotdensity(dens_test, bbdd$SchoolDaysFromMay302022)
dev.off()

rdplotdensity(dens_test, bbdd$SchoolDaysFromMay302022)






```

### Pregunta 2

```{r}
# ============================================================
# 2. First stage graph
# ============================================================

p2_1 <- ggplot(bbdd, aes(x = SchoolDaysFromMay302022, y = ListedInDropoutReport)) +
  geom_point(alpha = 0.2, color = "darkgrey") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  geom_smooth(data = subset(bbdd, SchoolDaysFromMay302022 < 0),
              method = "lm", se = FALSE, color = "blue") +
  geom_smooth(data = subset(bbdd, SchoolDaysFromMay302022 >= 0),
              method = "lm", se = FALSE, color = "green") +
  labs(title = "P2 - First Stage Graph",
       x = "Días escolares desde 30 de mayo 2022",
       y = "Probabilidad de estar listado en el reporte")
p2_1

ggsave(filename = "./outputs/P2_graf_firststage.png",
       plot = p2_1, width = 7, height = 5)

#b)
# Variable indicadora: 1 si dropout antes del 30 mayo
bbdd$DroppedOutMay30Before <- ifelse(bbdd$SchoolDaysFromMay302022 < 0, 1, 0)

# Modelo FE
model_firststage_fe <- feols(
  ListedInDropoutReport ~ DroppedOutMay30Before * SchoolDaysFromMay302022 | IDschool,
  data = bbdd
)

model_firststage_fe

# Guardar tabla HTML
modelsummary(model_firststage_fe,
             output = "./outputs/P2_reg_firststage_FE.html")


#c)

p2_2 <- ggplot(bbdd, aes(x = DayOfWeekDroppedOut)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(title = "P2 - Frecuencia de retiros por día de la semana",
       x = "Día de la semana de retiro",
       y = "Número de estudiantes")

p2_2

ggsave(filename = "./outputs/P2_graph_dayofweek.png",
       plot = p2_2, width = 7, height = 5)

model_firststage_week <- lm(ListedInDropoutReport ~ DroppedOutMay30Before +
                              SchoolDaysFromMay302022 +
                              DroppedOutMay30Before:SchoolDaysFromMay302022 +
                              factor(IDschool) +
                              factor(DayOfWeekDroppedOut),
                            data = bbdd)

model_firststage_week

# Guardar tabla HTML
modelsummary(model_firststage_week,
             output = "./outputs/P2_reg_firststage_week.html")





```

### Pregunta 3

```{r}

#RD lineal EnrolledByAug312022

rd_enrolled <- feols(
  EnrolledByAug312022 ~ DroppedOutMay30Before + SchoolDaysFromMay302022 + DroppedOutMay30Before:SchoolDaysFromMay302022 | 
  IDschool + DayOfWeekDroppedOut,
  data = bbdd, cluster = "IDschool" #esto hace que los errores estándar se ajusten por correlación dentro de cada escuela
)
summary(rd_enrolled)

#RD lineal GraduatedIn2022
rd_graduated <- feols(
  GraduatedIn2022 ~ DroppedOutMay30Before + SchoolDaysFromMay302022 + DroppedOutMay30Before:SchoolDaysFromMay302022 | 
  IDschool + DayOfWeekDroppedOut,
  data = bbdd, cluster = "IDschool"
)
summary(rd_graduated)


```

### Pregunta 4

```{r}
#EnrolledByAug312022
plot_enrolled <- rdplot(y = bbdd$EnrolledByAug312022, x = bbdd$SchoolDaysFromMay302022, c = 0,
                        title = "Revinculación al 31 de agosto")

#GraduatedIn2022
plot_graduated <- rdplot(y = bbdd$GraduatedIn2022, x = bbdd$SchoolDaysFromMay302022, c = 0,
                         title = "Graduación en 2022")

#Gráficos
g1 <- plot_enrolled$rdplot
g2 <- plot_graduated$rdplot

#Combinar gráficos 
ggarrange(g1, g2, ncol = 2, nrow = 1)

```

### Pregunta 5

```{r}
#EnrolledByAug312022 con términos cuadráticos
rd_quad_enrolled <- feols(
  EnrolledByAug312022 ~ DroppedOutMay30Before +
    SchoolDaysFromMay302022 + I(SchoolDaysFromMay302022^2) +
    DroppedOutMay30Before:SchoolDaysFromMay302022 + DroppedOutMay30Before:I(SchoolDaysFromMay302022^2) |
    IDschool + DayOfWeekDroppedOut,
  data = bbdd, cluster = "IDschool"
)
summary(rd_quad_enrolled)

#GraduatedIn2022 con términos cuadráticos
rd_quad_graduated <- feols(
  GraduatedIn2022 ~ DroppedOutMay30Before +
    SchoolDaysFromMay302022 + I(SchoolDaysFromMay302022^2) +
    DroppedOutMay30Before:SchoolDaysFromMay302022 + DroppedOutMay30Before:I(SchoolDaysFromMay302022^2) |
    IDschool + DayOfWeekDroppedOut,
  data = bbdd, cluster = "IDschool"
)
summary(rd_quad_graduated)

```

### Pregunta 6

```{r}
#Proyección cuadrática
plot_quad <- rdplot(y = bbdd$EnrolledByAug312022, x = bbdd$SchoolDaysFromMay302022, c = 0, p = 2,
                    title = "Revinculación - Proyección cuadrática")

#Proyección cúbica
plot_cubic <- rdplot(y = bbdd$EnrolledByAug312022, x = bbdd$SchoolDaysFromMay302022, c = 0, p = 3,
                     title = "Revinculación - Proyección cúbica")

#Combinar ambos gráficos
ggarrange(plot_quad$rdplot, plot_cubic$rdplot, ncol = 2, nrow = 1)

```

### WAR
