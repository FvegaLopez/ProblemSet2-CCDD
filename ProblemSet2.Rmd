---
title: "ProblemSet2"
output: html_document
---

```{r, warning=FALSE, message=FALSE}
# Carga de librerias
# --- Paquetes ---
library(haven)      # leer .dta
library(ggplot2)    # gráficos
library(rddensity)  # test de manipulación
library(fixest)     # regresiones con FE
library(rdrobust)   # rdplot
library(dplyr)
library(ggpubr)     # Combinar gráficos
library(modelsummary)
library(knitr)
library(kableExtra)
library(rlang)
library(xtable)
```

```{r}
bbdd = read_dta("./data/casestudy_dropout.dta")
bbdd
```

### Pregunta 1

```{r}
# --- Gráfico 1: histograma simple ---
p1 <- ggplot(bbdd, aes(x = SchoolDaysFromMay302022)) +
  geom_histogram(binwidth = 1, fill = "lightblue", color = "black") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  labs(title = "Distribución de la running variable",
       x = "Días escolares desde 30 de mayo 2022",
       y = "Frecuencia")

p1

ggsave(filename ="./outputs/grafico1_histograma.png", plot = p1, width = 7, height = 5)

# 1. Construir tabla de frecuencias
freq_df <- bbdd %>%
  count(SchoolDaysFromMay302022)

# 2. Ajustar regresiones lineales a cada lado del cutoff
lm_left  <- lm(n ~ SchoolDaysFromMay302022, data = subset(freq_df, SchoolDaysFromMay302022 < 0))
lm_right <- lm(n ~ SchoolDaysFromMay302022, data = subset(freq_df, SchoolDaysFromMay302022 >= 0))

# 3. Graficar histograma + líneas ajustadas
p2 <- ggplot(freq_df, aes(x = SchoolDaysFromMay302022, y = n)) +
  geom_col(fill = "lightblue", color = "black") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  geom_smooth(data = subset(freq_df, SchoolDaysFromMay302022 < 0),
              method = "lm", se = FALSE, color = "blue") +
  geom_smooth(data = subset(freq_df, SchoolDaysFromMay302022 >= 0),
              method = "lm", se = FALSE, color = "green") +
  labs(title = "Distribución de la running variable con ajuste lineal",
       x = "Días escolares desde 30 de mayo 2022",
       y = "Frecuencia")

p2

ggsave(filename = "./outputs/grafico2_histograma_lineal.png", plot = p2, width = 7, height = 5)



# Test de densidad
dens_test <- rddensity(X = bbdd$SchoolDaysFromMay302022, c = 0)
summary(dens_test)



# Guardar gráfico de densidad
png(filename = "./outputs/grafico3_rddensity.png", width = 800, height = 600)
rdplotdensity(dens_test, bbdd$SchoolDaysFromMay302022)
dev.off()

rdplotdensity(dens_test, bbdd$SchoolDaysFromMay302022)






```

### Pregunta 2

```{r}
# ============================================================
# 2. First stage graph
# ============================================================

p2_1 <- ggplot(bbdd, aes(x = SchoolDaysFromMay302022, y = ListedInDropoutReport)) +
  geom_point(alpha = 0.2, color = "darkgrey") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", size = 1) +
  geom_smooth(data = subset(bbdd, SchoolDaysFromMay302022 < 0),
              method = "lm", se = FALSE, color = "blue") +
  geom_smooth(data = subset(bbdd, SchoolDaysFromMay302022 >= 0),
              method = "lm", se = FALSE, color = "green") +
  labs(title = "P2 - 1st Stage",
       x = "Días escolares desde 30 de mayo 2022",
       y = "Probabilidad de estar listado en el reporte")
p2_1

ggsave(filename = "./outputs/P2_graf_firststage.png",
       plot = p2_1, width = 7, height = 5)

#b)

# Modelo FE
model_firststage_fe <- feols(
  ListedInDropoutReport ~ DroppedOutMay30Before * SchoolDaysFromMay302022 | IDschool,
  data = bbdd
)

model_firststage_fe

# Guardar tabla HTML
modelsummary(model_firststage_fe,
             output = "./outputs/P2_reg_firststage_EF.html",
             coef_omit = "IDschool",   
             gof_omit = "IC|Log|F")


#c)

p2_2 <- ggplot(bbdd, aes(x = DayOfWeekDroppedOut)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(title = "P2 - Frecuencia de retiros por día de la semana",
       x = "Día de la semana de retiro",
       y = "Número de estudiantes")

p2_2

ggsave(filename = "./outputs/P2_graf_semana.png",
       plot = p2_2, width = 7, height = 5)

model_firststage_week <- feols(
  ListedInDropoutReport ~ DroppedOutMay30Before * SchoolDaysFromMay302022 | 
    IDschool + DayOfWeekDroppedOut,
  data = bbdd,
  cluster = ~IDschool   # opcional: errores clusterizados por escuela
)

model_firststage_week

# Guardar tabla HTML
modelsummary(model_firststage_week,
             output = "./outputs/P2_reg_firststage_semana.html",
             coef_omit = "IDschool|DayOfWeekDroppedOut",
             gof_omit = "IC|Log|F")
```

### Pregunta 3

```{r}

# ============================================================
# RD lineal - EnrolledByAug312022
# ============================================================
rd_enrolled <- feols(
  EnrolledByAug312022 ~ DroppedOutMay30Before +
    SchoolDaysFromMay302022 +
    DroppedOutMay30Before:SchoolDaysFromMay302022 | 
    IDschool + DayOfWeekDroppedOut,
  data = bbdd,
  cluster = "IDschool"
)

summary(rd_enrolled)

# Guardar resultados como HTML
modelsummary(rd_enrolled,
             output = "./outputs/P3_reg_enrolled.html",
             title = "RD lineal - Enrolled by Aug 31, 2022")

# ============================================================
# RD lineal - GraduatedIn2022
# ============================================================
rd_graduated <- feols(
  GraduatedIn2022 ~ DroppedOutMay30Before +
    SchoolDaysFromMay302022 +
    DroppedOutMay30Before:SchoolDaysFromMay302022 | 
    IDschool + DayOfWeekDroppedOut,
  data = bbdd,
  cluster = "IDschool"
)

summary(rd_graduated)

# Guardar resultados como HTML
modelsummary(rd_graduated,
             output = "./outputs/P3_reg_graduated.html",
             title = "RD lineal - Graduated in 2022")


```

### Pregunta 4

```{r}
#EnrolledByAug312022
plot_enrolled <- rdplot(y = bbdd$EnrolledByAug312022, x = bbdd$SchoolDaysFromMay302022, c = 0,
                        title = "Revinculación al 31 de agosto")

#GraduatedIn2022
plot_graduated <- rdplot(y = bbdd$GraduatedIn2022, x = bbdd$SchoolDaysFromMay302022, c = 0,
                         title = "Graduación en 2022")

#Gráficos
g1 <- plot_enrolled$rdplot
g2 <- plot_graduated$rdplot

# Guardar cada gráfico por separado
ggsave("./outputs/P4_graf_enrolado.png", g1, width = 7, height = 5, dpi = 300)
ggsave("./outputs/P4_graf_graduado.png", g2, width = 7, height = 5, dpi = 300)

# Combinar y guardar juntos
g_combined <- ggarrange(g1, g2, ncol = 2, nrow = 1)
g_combined
ggsave("./outputs/P4_grapf_combinado.png", g_combined, width = 12, height = 5, dpi = 300)

```

### Pregunta 5

```{r}
#EnrolledByAug312022 con términos cuadráticos
rd_quad_enrolled <- feols(
  EnrolledByAug312022 ~ DroppedOutMay30Before +
    SchoolDaysFromMay302022 + I(SchoolDaysFromMay302022^2) +
    DroppedOutMay30Before:SchoolDaysFromMay302022 + DroppedOutMay30Before:I(SchoolDaysFromMay302022^2) |
    IDschool + DayOfWeekDroppedOut,
  data = bbdd, cluster = "IDschool"
)
summary(rd_quad_enrolled)

# Guardar resultados como HTML
modelsummary(rd_quad_enrolled,
             output = "./outputs/P5_reg_enrolado.html",
             title = "RD cuadrático - Enrolled by Aug 31, 2022")

#GraduatedIn2022 con términos cuadráticos
rd_quad_graduated <- feols(
  GraduatedIn2022 ~ DroppedOutMay30Before +
    SchoolDaysFromMay302022 + I(SchoolDaysFromMay302022^2) +
    DroppedOutMay30Before:SchoolDaysFromMay302022 + DroppedOutMay30Before:I(SchoolDaysFromMay302022^2) |
    IDschool + DayOfWeekDroppedOut,
  data = bbdd, cluster = "IDschool"
)
summary(rd_quad_graduated)

# Guardar resultados como HTML
modelsummary(rd_quad_graduated,
             output = "./outputs/P5_reg_graduado.html",
             title = "RD cuadrático - Graduated in 2022")

```

### Pregunta 6

```{r}
#Proyección cuadrática
plot_cuad <- rdplot(y = bbdd$EnrolledByAug312022, x = bbdd$SchoolDaysFromMay302022, c = 0, p = 2,
                    title = "Revinculación - Proyección cuadrática")

#Proyección cúbica
plot_cubic <- rdplot(y = bbdd$EnrolledByAug312022, x = bbdd$SchoolDaysFromMay302022, c = 0, p = 3,
                     title = "Revinculación - Proyección cúbica")

# Extraer gráficos ggplot
g_cuad <- plot_cuad$rdplot
g_cubic <- plot_cubic$rdplot

# Guardar por separado
ggsave("./outputs/P6_graf_cuad.png", g_cuad, width = 7, height = 5, dpi = 300)
ggsave("./outputs/P6_graf_cubic.png", g_cubic, width = 7, height = 5, dpi = 300)

# Combinar y guardar juntos (lado a lado)
g_combinado <- ggarrange(g_cuad, g_cubic, ncol = 2, nrow = 1)
g_combinado
ggsave("./outputs/P6_graf_cuad_cubic_combinado.png", g_combinado, width = 12, height = 5, dpi = 300)

```

### Pregunta 7

```{r}
library(rdrobust)

rdplot(y = bbdd$GraduatedIn2021,
       x = bbdd$SchoolDaysFromMay302022,
       c = 0,                  # cutoff en 0 días (30 mayo 2022)
       p = 1,                  # proyección lineal a cada lado
       binselect = "esmv",     # método de bins sugerido
       x.label = "Días escolares desde 30 de mayo 2022",
       y.label = "Graduated in 2021",
       title = "RD Placebo: GraduatedIn2021 vs. SchoolDaysFromMay302022")
```

### Pregunta 8

```{r}

# Ajuste lineal RD incluyendo covariables de pretratamiento
# outcome: GraduatedIn2021
# running: SchoolDaysFromMay302022
# cutoff: 0
# covariables: GPAin2021, AttendanceIn2021, Female, Migrant

modelo_placebo_cov <- rdrobust(y = bbdd$GraduatedIn2021,
                               x = bbdd$SchoolDaysFromMay302022,
                               covs = bbdd[, c("GPAin2021","AttendanceIn2021","Female","Migrant")],
                               c = 0, p = 1)

summary(modelo_placebo_cov)

# rdplot sólo grafica el ajuste sin covariables, pero sirve para visualizar
rdplot(y = bbdd$GraduatedIn2021,
       x = bbdd$SchoolDaysFromMay302022,
       c = 0, p = 1,
       x.label = "Días escolares desde 30 de mayo 2022",
       y.label = "Graduated in 2021",
       title = "RD Placebo con covariables: GraduatedIn2021 vs SchoolDaysFromMay302022")
```
